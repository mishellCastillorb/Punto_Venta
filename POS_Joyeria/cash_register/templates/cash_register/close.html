{% extends "home/base_pos.html" %}
{% block title %}Cerrar caja{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto bg-white p-6 rounded shadow">
  <h2 class="text-xl font-bold mb-4">Cerrar caja</h2>

  <ul class="mb-4 text-sm">
    <li>Efectivo sistema: <strong>${{ cash_total|floatformat:2 }}</strong></li>
    <li>Tarjeta: <strong>${{ card_total|floatformat:2 }}</strong></li>
    <li>Transferencia: <strong>${{ transfer_total|floatformat:2 }}</strong></li>
    <li>Total ventas: <strong>${{ total_sales|floatformat:2 }}</strong></li>
  </ul>

  <form method="post">
    {% csrf_token %}

    <label class="block mb-2 text-sm font-medium">Efectivo contado</label>
    <input
      type="number"
      step="0.01"
      min="0"
      name="closing_amount"
      class="border p-2 rounded w-full"
      required
    >

    <p class="text-sm mt-2 text-gray-600">
      Efectivo esperado: <strong>${{ cash_total|floatformat:2 }}</strong>
    </p>

    <!-- MENSAJE DINÁMICO -->
    <p id="diff-msg" class="text-sm mt-2 hidden"></p>

    <div class="mt-2 text-sm text-red-600">
      Si el efectivo contado es menor al esperado, se registrará un <strong>faltante</strong>.
    </div>

    <button class="w-full bg-red-600 text-white py-2 rounded mt-4">
      Confirmar cierre
    </button>
  </form>
</div>

<script>
  const input = document.querySelector('input[name="closing_amount"]');
  const diffMsg = document.getElementById('diff-msg');
  const expected = parseFloat("{{ cash_total|floatformat:2 }}");

  input.addEventListener('input', () => {
    const val = parseFloat(input.value || 0);
    const diff = val - expected;

    diffMsg.classList.remove("hidden");

    if (diff < 0) {
      diffMsg.textContent = `Faltante: $${Math.abs(diff).toFixed(2)}`;
      diffMsg.className = "text-sm mt-2 text-red-600";
    } else if (diff > 0) {
      diffMsg.textContent = `Sobrante: $${diff.toFixed(2)}`;
      diffMsg.className = "text-sm mt-2 text-green-600";
    } else {
      diffMsg.textContent = "Caja cuadrada ✔";
      diffMsg.className = "text-sm mt-2 text-gray-600";
    }
  });
</script>
{% endblock %}
